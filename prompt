clean up warnings and harden tests
