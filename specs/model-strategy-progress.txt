
[R1] DONE — Added --model-strategy and --model CLI args to Args in cli.rs with env var support (RALPH_MODEL_STRATEGY, RALPH_MODEL). Added resolve_model_strategy() validation method and 10 unit tests covering: --model alone implies fixed, fixed without model errors, default is cost-optimized, invalid model/strategy names error, valid models/strategies accepted, env var equivalence.

[R2] DONE — Added ModelStrategy enum (Fixed, CostOptimized, Escalate, PlanThenExecute) with Display and from_str to config.rs. Added model_strategy, model, current_model fields to Config. Wired Config::from_args to call resolve_model_strategy(), validate fixed+model, and set initial current_model per strategy (fixed→configured model, cost-optimized→sonnet, escalate→haiku, plan-then-execute→opus). next_iteration preserves all strategy state via ..self.clone(). Added 10 unit tests. All 20 tests pass.

[R3] DONE — Created src/strategy.rs module with select_model(config, hint) function. Fixed strategy always returns config.model unconditionally. Hint parameter overrides any strategy when provided. Wired select_model into run_loop.rs so model is re-selected after each next_iteration(). Registered strategy module in main.rs. Added 6 unit tests: returns configured model for opus/haiku/sonnet, same model across 10 iterations, ignores iteration number at iteration 50, hint overrides fixed strategy. All 26 tests pass.

[R4] DONE — Implemented cost-optimized strategy in strategy.rs. Added select_cost_optimized() which reads the progress file and delegates to analyze_progress() pure heuristic. Heuristic: error/failure/stuck signals → opus; ≥3 DONE/completed markers with no errors → haiku; otherwise → sonnet (default). Added 10 unit tests covering: empty progress → sonnet, ambiguous → sonnet, error signals → opus, failure → opus, stuck → opus, steady completions → haiku, insufficient completions → sonnet, errors override completions → opus, default iteration 1 → sonnet, hint overrides cost-optimized. All 36 tests pass.

[R5] DONE — Implemented escalate strategy with level tracking. Added escalation_level: u8 field to Config (0=haiku, 1=sonnet, 2=opus). Added select_escalate() which reads progress file and calls assess_escalation_need() — severe signals (stuck/cannot/unable/panic/crash/broken/regression) → opus level, moderate signals (error/failure/failed/bug) → sonnet level, clean → no escalation. Escalation is monotonic upward (never auto-de-escalates); only Claude hint de-escalates (updates escalation_level via model_to_level). Changed select_model signature from &Config to &mut Config. Added helper functions model_to_level() and level_to_model(). Updated run_loop.rs to pass &mut config. Added 10 unit tests covering: starts at haiku, no distress stays haiku, moderate→sonnet level, severe→opus level, never auto-de-escalates, escalation sequence, hint de-escalates, hint escalates, model-to-level mapping, level persists across iterations. All 46 tests pass.

[R6] DONE — Implemented plan-then-execute strategy in strategy.rs. Added select_plan_then_execute() function: iteration 1 returns "opus", iterations 2+ return "sonnet". Claude hint overrides apply via the existing hint mechanism in select_model(). Replaced PlanThenExecute placeholder arm with call to select_plan_then_execute(). Added 9 unit tests covering: iteration 1 returns opus, iteration 2 returns sonnet, iteration 5 returns sonnet, hint overrides to haiku, hint overrides to opus, hint overrides iteration 1, config starts at opus, direct function iteration 1, direct function iteration 2+. All 55 tests pass.

[R7] DONE — Parsed <next-model> sigil from result text and wired hint into model selection. Added parse_next_model_hint() function to events.rs that extracts valid model names (opus/sonnet/haiku) from <next-model>...</next-model> tags, returning None for absent/malformed/invalid sigils. Added next_model_hint: Option<String> field to ResultEvent. Updated parser.rs to call parse_next_model_hint when constructing ResultEvent. Updated client.rs stream_output to preserve the hint field. Updated run_loop.rs to extract next_model_hint from the result and pass it to strategy::select_model for the next iteration. Added 14 unit tests covering: parse opus/sonnet/haiku, whitespace inside tags, absent sigil, empty text, invalid model, empty model, malformed (no closing/opening tag), alongside COMPLETE sigil, first occurrence wins, default event has no hint, event with hint. All 69 tests pass.

[R8] DONE — Added <next-model> sigil documentation to build_system_prompt in client.rs. New "Model Hint" section explains the sigil syntax with all three examples (<next-model>opus</next-model>, <next-model>sonnet</next-model>, <next-model>haiku</next-model>), rules (next iteration only, not persistent, valid values, optional), and guidance on when to use it. Added 8 unit tests in new client::tests module covering: prompt contains <next-model> tag, all three model names present, each model example present, completion sigils present, prompt/progress file references present. All 77 tests pass.

[R9] DONE — Implemented override logging. Refactored select_model() to return ModelSelection struct with fields: model, strategy_choice, hint, was_overridden. The strategy's choice is always computed first, then the hint overrides if present; was_overridden is true when hint != strategy_choice. Added log_model_override() function that appends "[model-override] iteration=N strategy_choice=X hint=Y" to the progress file. Updated run_loop.rs to call log_model_override when selection.was_overridden is true. Updated all existing tests to use .model accessor. Added 9 new unit tests: no_hint_means_no_override, hint_matching_strategy_is_not_override, hint_differing_from_strategy_is_override, override_logged_to_progress_file, no_override_means_no_log_entry, override_appends_to_existing_progress_file, plan_then_execute_override_detected_on_iteration_2, plan_then_execute_no_override_when_hint_matches, escalate_override_detected_when_hint_differs. All 86 tests pass.

[R10] DONE — Wired --model <current_model> into claude CLI args. Extracted build_claude_args() helper from run() in client.rs for testability. The args vec now includes "--model" followed by config.current_model, inserted before "--system-prompt". Added 5 unit tests: args contain --model flag, --model followed by correct model name, fixed strategy passes configured model (opus), escalate strategy passes initial model (haiku), plan-then-execute strategy passes initial model (opus). All 91 tests pass.

[R11] DONE — Verified model display in formatter.rs. Line 23-24 already prints the model from assistant.model via `format!("→ {}", model).purple()`. No code change needed — the selected model is passed via --model to the claude CLI (R10), and the assistant event's model field reflects it.

[DOCS] DONE — Updated README.md: added --model/--model-strategy examples to Usage, new "Model Strategy" section with strategy descriptions and Claude hint docs, added --model and --model-strategy to CLI Reference, added RALPH_MODEL/RALPH_MODEL_STRATEGY to env vars table. Updated CLAUDE.md: added "Model Strategy (src/strategy.rs)" architecture section, updated Claude Integration bullet points to mention --model and <next-model> hint parsing, added --model/--model-strategy to CLI Flags, added <next-model> to Completion Detection sigils, added RALPH_MODEL/RALPH_MODEL_STRATEGY to env vars. All 91 tests pass.
